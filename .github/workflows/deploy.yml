name: Deploy CRM Frontend

on:
  push:
    branches: [main]
  pull_request:
    branches: ['**']

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build frontend
        run: yarn build

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload project to server (—Ç—ñ–ª—å–∫–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          source: '.'
          target: ~/proj-crm-frontend-main
          strip_components: 0
          rm: true
          debug: true

      - name: Deploy Docker container on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É –ø—Ä–æ—î–∫—Ç—É"
            cd ~/proj-crm-frontend-main

            echo "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è SSL —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (—è–∫—â–æ —â–µ –Ω–µ —ñ—Å–Ω—É—é—Ç—å)..."
            mkdir -p ssl
            if [ ! -f ssl/crm.crt ]; then
              openssl req -x509 -nodes -days 365 \
                -newkey rsa:2048 \
                -keyout ssl/selfsigned.key \
                -out ssl/selfsigned.crt \
                -subj "/C=UA/ST=Kyiv/L=Kyiv/O=CRM/OU=IT/CN=crm-project.pp.ua"
              echo "‚úÖ –°–∞–º–æ–ø—ñ–¥–ø–∏—Å–∞–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ"
            else
              echo "üîê –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –≤–∂–µ —ñ—Å–Ω—É—é—Ç—å ‚Äî –Ω–µ –≥–µ–Ω–µ—Ä—É—î–º–æ –∑–∞–Ω–æ–≤–æ"
            fi

            echo "–ó—É–ø–∏–Ω–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—è–∫—â–æ —î)..."
            docker stop crmfrontend || true
            docker rm crmfrontend || true

            echo "–ó–±—ñ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ Docker-–æ–±—Ä–∞–∑—É..."
            docker build -t crmfrontend .

            echo "–ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker run -d \
              --name crmfrontend \
              --network crm-network \
              --restart always \
              -p 443:443 \
              crmfrontend
